<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teacher Dashboard</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Import the Inter font for a clean, modern look */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Custom styles for the message modal */
        #messageModal, #promptModal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgb(0,0,0);
            background-color: rgba(0,0,0,0.4);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fefefe;
            padding: 24px;
            border-radius: 12px;
            border: 1px solid #888;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        .prompt-input {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border-radius: 8px;
            border: 1px solid #ccc;
        }
        .prompt-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        /* Custom styles for the file input button */
        .custom-file-input::-webkit-file-upload-button {
            visibility: hidden;
        }
        .custom-file-input::before {
            content: 'üìé Pick Document/File';
            display: inline-block;
            background-color: #1abc9c;
            color: #fff;
            font-weight: bold;
            font-size: 16px;
            padding: 12px;
            border-radius: 8px;
            outline: none;
            white-space: nowrap;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .custom-file-input:hover::before {
            background-color: #16a085;
        }
        .custom-file-input:active::before {
            background-color: #1abc9c;
            box-shadow: none;
        }

        /* Custom loading spinner */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #fff;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Profile Dropdown Custom Styling */
        .dropdown-menu {
            transition: opacity 0.2s ease-in-out, transform 0.2s ease-in-out;
            transform: translateY(-5px);
        }

        .dropdown-menu.visible {
            opacity: 1;
            transform: translateY(0);
        }
    </style>
</head>
<body class="bg-slate-100 min-h-screen">

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 flex items-center justify-center bg-gray-200 bg-opacity-75 z-[999]">
        <div class="text-center p-6 bg-white rounded-xl shadow-lg">
            <div class="spinner mx-auto mb-4 border-blue-500 border-t-blue-500"></div>
            <p class="text-lg text-gray-700 font-medium">Loading teacher dashboard...</p>
        </div>
    </div>

    <!-- Message Modal -->
    <div id="messageModal" class="flex">
        <div class="modal-content">
            <span class="close-button" onclick="closeMessageModal()">&times;</span>
            <h2 id="modalTitle" class="text-xl font-bold mb-2 text-gray-800"></h2>
            <p id="modalMessage" class="text-gray-700"></p>
            <div class="flex justify-end mt-4">
                <button onclick="closeMessageModal()" class="px-4 py-2 bg-blue-500 text-white rounded-lg shadow-md hover:bg-blue-600 transition-colors">OK</button>
            </div>
        </div>
    </div>
    
    <!-- Prompt Modal -->
    <div id="promptModal" class="flex">
        <div class="modal-content">
            <h2 id="promptTitle" class="text-xl font-bold mb-2 text-gray-800"></h2>
            <p id="promptMessage" class="text-gray-700 mb-4"></p>
            <textarea id="promptInput" class="w-full h-32 p-3 mb-4 border border-gray-300 rounded-lg text-gray-800 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Type your message here..."></textarea>
            <div class="prompt-buttons">
                <button id="cancelPromptBtn" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-lg shadow-md hover:bg-gray-400 transition-colors">Cancel</button>
                <button id="okPromptBtn" class="px-4 py-2 bg-blue-500 text-white rounded-lg shadow-md hover:bg-blue-600 transition-colors">Send</button>
            </div>
        </div>
    </div>

    <div class="container mx-auto p-4 sm:p-6 lg:p-8 space-y-6">
        
        <!-- Top Bar with Header and Profile Dropdown -->
        <header class="flex flex-col sm:flex-row justify-between items-center py-4 border-b border-gray-200">
            <h1 class="text-3xl font-bold text-gray-800 mb-4 sm:mb-0">üìö Teacher Dashboard</h1>

            <!-- Profile Dropdown Menu with Image -->
            <div class="relative inline-block text-left">
                <!-- Dropdown toggle button -->
                <button id="profile-menu-button" type="button" class="flex items-center space-x-2 rounded-full px-4 py-2 hover:bg-gray-200 transition duration-150 ease-in-out focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                    <!-- Profile Image Placeholder -->
                    <span class="inline-flex items-center justify-center h-10 w-10 rounded-full bg-blue-500">
                        <span class="font-medium text-lg text-white">TS</span>
                    </span>
                    <!-- User Name Placeholder -->
                    <span class="font-medium text-gray-700 hidden sm:inline">Teacher</span>
                    <!-- Dropdown Arrow Icon -->
                    <svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                </button>

                <!-- Dropdown menu, initially hidden -->
                <div id="profile-dropdown-menu" class="hidden origin-top-right absolute right-0 mt-2 w-48 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 focus:outline-none dropdown-menu opacity-0" role="menu" aria-orientation="vertical" aria-labelledby="profile-menu-button">
                    <div class="py-1" role="none">
                        <!-- Profile link -->
                        <a href="profile.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" role="menuitem">
                            Your Profile
                        </a>
                        <!-- Settings link -->
                        <a href="settings.html" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" role="menuitem">
                            Settings
                        </a>
                        <hr class="my-1 border-gray-100" role="none">
                        <!-- Logout button -->
                        <button id="logoutButton" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" role="menuitem">
                            üö™ Sign out
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content Sections -->
        
        <!-- Tab Navigation -->
        <nav class="flex flex-wrap sm:flex-nowrap justify-around items-center bg-gray-200 rounded-xl p-3 shadow-md">
            <a href="my-class-students.html" class="flex-1 text-center py-2 px-3 m-1 bg-blue-500 text-white font-bold rounded-lg shadow-sm hover:bg-blue-600 transition-colors">
                üë®‚Äçüéì My Class
            </a>
            <a href="completed-assigned-tasks.html" class="flex-1 text-center py-2 px-3 m-1 bg-blue-500 text-white font-bold rounded-lg shadow-sm hover:bg-blue-600 transition-colors">
                ‚úÖ Completed Tasks
            </a>
            <a href="other-student.html" class="flex-1 text-center py-2 px-3 m-1 bg-blue-500 text-white font-bold rounded-lg shadow-sm hover:bg-blue-600 transition-colors">
                üè´ Other School
            </a>
        </nav>

        <!-- Students in Your Class Section -->
        <section id="studentsSection" class="bg-white rounded-xl p-6 shadow-lg">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4 border-b pb-2">üéì Students in Your Class</h2>
            <div id="studentsList" class="divide-y divide-gray-200">
                <!-- Students will be rendered here by JS -->
            </div>
        </section>

        <!-- Create and Send Assignment Section -->
        <section class="bg-white rounded-xl p-6 shadow-lg">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4 border-b pb-2">‚úèÔ∏è Create and Send Assignment</h2>
            
            <label for="student-select" class="block text-gray-700 font-bold mb-2">Select Student:</label>
            <div id="studentSelectContainer" class="border border-gray-300 rounded-lg overflow-hidden mb-4">
                <select id="student-select" class="w-full p-3 bg-white text-gray-800 focus:outline-none">
                    <!-- Options will be populated by JS -->
                </select>
            </div>

            <label for="assignmentText" class="block text-gray-700 font-bold mb-2">Assignment Details (min 500 words or attach file):</label>
            <textarea id="assignmentText" class="w-full min-h-[150px] p-4 mb-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 resize-y" placeholder="Type your assignment here..." maxlength="5000"></textarea>
            <p id="wordCountText" class="text-sm text-gray-500 text-right mb-4">Word count: 0</p>
            
            <div class="flex flex-col sm:flex-row items-center justify-between gap-4 mb-4">
                <label for="assignmentFile" class="custom-file-input cursor-pointer text-base">
                    <input type="file" id="assignmentFile" class="hidden">
                </label>
                <div id="fileStatus" class="flex items-center gap-2">
                    <span id="fileName" class="text-gray-700 text-sm italic">No file selected.</span>
                    <button id="clearFileButton" class="text-red-500 hover:text-red-700 hidden text-sm font-semibold">Clear</button>
                </div>
            </div>
            
            <button id="sendAssignmentButton" class="w-full py-4 bg-blue-500 text-white font-bold rounded-lg shadow-md hover:bg-blue-600 transition-colors transform hover:scale-105" disabled>
                Send Assignment
            </button>
        </section>
        
        <!-- Overdue Tasks Section -->
        <section class="bg-white rounded-xl p-6 shadow-lg">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4 border-b pb-2">üìå Overdue Tasks</h2>
            <div id="overdueTasksList" class="divide-y divide-gray-200">
                <!-- Overdue tasks will be rendered here by JS -->
            </div>
        </section>

        <!-- Assigned Tasks Section -->
        <section class="bg-white rounded-xl p-6 shadow-lg">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4 border-b pb-2">üìù Assigned Tasks</h2>
            <div id="assignedTasksList" class="divide-y divide-gray-200">
                <!-- Assigned tasks will be rendered here by JS -->
            </div>
        </section>

        <!-- Student Feedback Section -->
        <section class="bg-white rounded-xl p-6 shadow-lg">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4 border-b pb-2">üí¨ Student Feedback</h2>
            <div id="feedbackList" class="divide-y divide-gray-200">
                <!-- Feedback will be rendered here by JS -->
            </div>
        </section>

        <!-- Academic Calendar Section -->
        <section class="bg-white rounded-xl p-6 shadow-lg">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4 border-b pb-2">üìÖ Academic Calendar</h2>
            <input type="date" id="termStart" class="w-full p-3 mb-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="Start of Term (YYYY-MM-DD)">
            <input type="date" id="termEnd" class="w-full p-3 mb-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="End of Term (YYYY-MM-DD)">
            <button id="saveCalendarButton" class="w-full py-3 bg-green-500 text-white font-bold rounded-lg shadow-md hover:bg-green-600 transition-colors transform hover:scale-105">
                Save Calendar
            </button>
            <p id="calendarMsg" class="text-center font-semibold mt-4 text-gray-700"></p>
        </section>
        
        <!-- Footer -->
        <footer class="text-center text-sm text-gray-500 py-6 mt-4">
            ¬© <span id="currentYear"></span> SmartStudent
        </footer>
    </div>

    <script>
        // --- State Variables ---
        let students = [];
        let overdueTasks = [];
        let assignedTasks = [];
        let feedbackList = [];
        let selectedAssignmentFile = null;
        let isDropdownVisible = false;

        // --- DOM Elements ---
        const loadingOverlay = document.getElementById('loadingOverlay');
        const studentsListEl = document.getElementById('studentsList');
        const overdueTasksListEl = document.getElementById('overdueTasksList');
        const assignedTasksListEl = document.getElementById('assignedTasksList');
        const feedbackListEl = document.getElementById('feedbackList');
        const studentSelectEl = document.getElementById('student-select');
        const assignmentTextEl = document.getElementById('assignmentText');
        const wordCountTextEl = document.getElementById('wordCountText');
        const assignmentFileEl = document.getElementById('assignmentFile');
        const fileNameEl = document.getElementById('fileName');
        const clearFileButtonEl = document.getElementById('clearFileButton');
        const sendAssignmentButtonEl = document.getElementById('sendAssignmentButton');
        const termStartEl = document.getElementById('termStart');
        const termEndEl = document.getElementById('termEnd');
        const saveCalendarButtonEl = document.getElementById('saveCalendarButton');
        const calendarMsgEl = document.getElementById('calendarMsg');
        
        // New dropdown DOM elements
        const profileMenuButton = document.getElementById('profile-menu-button');
        const profileDropdownMenu = document.getElementById('profile-dropdown-menu');
        const logoutButtonEl = document.getElementById('logoutButton');

        const messageModal = document.getElementById('messageModal');
        const modalTitleEl = document.getElementById('modalTitle');
        const modalMessageEl = document.getElementById('modalMessage');

        const promptModal = document.getElementById('promptModal');
        const promptTitleEl = document.getElementById('promptTitle');
        const promptMessageEl = document.getElementById('promptMessage');
        const promptInputEl = document.getElementById('promptInput');
        const okPromptBtn = document.getElementById('okPromptBtn');
        const cancelPromptBtn = document.getElementById('cancelPromptBtn');

        const API_BASE = 'https://smartstudent-backend.onrender.com';

        // --- Helper Functions ---
        /**
         * Simple function to sanitize string inputs to prevent XSS attacks.
         * Note: This is client-side validation and is NOT a substitute for
         * robust server-side validation. Server-side validation is mandatory
         * for real security.
         * @param {string} str The string to sanitize.
         * @returns {string} The sanitized string.
         */
        function sanitizeInput(str) {
            if (typeof str !== 'string') return '';
            const tempDiv = document.createElement('div');
            tempDiv.textContent = str;
            return tempDiv.innerHTML;
        }

        /**
         * Displays a custom message modal.
         * @param {string} title The title of the modal.
         * @param {string} message The message to display.
         */
        function showMessageModal(title, message) {
            modalTitleEl.textContent = title;
            modalMessageEl.textContent = message;
            messageModal.style.display = 'flex';
        }

        /**
         * Closes the message modal.
         */
        function closeMessageModal() {
            messageModal.style.display = 'none';
        }

        /**
         * Displays a custom prompt modal for user input.
         * @param {string} title The title of the prompt.
         * @param {string} message The message to display.
         * @returns {Promise<string|null>} A promise that resolves with the user's input or null if canceled.
         */
        function showPromptModal(title, message) {
            return new Promise((resolve) => {
                promptTitleEl.textContent = title;
                promptMessageEl.textContent = message;
                promptInputEl.value = ''; // Clear previous input
                promptModal.style.display = 'flex';

                const onOk = () => {
                    resolve(promptInputEl.value);
                    promptModal.style.display = 'none';
                    okPromptBtn.removeEventListener('click', onOk);
                    cancelPromptBtn.removeEventListener('click', onCancel);
                };

                const onCancel = () => {
                    resolve(null);
                    promptModal.style.display = 'none';
                    okPromptBtn.removeEventListener('click', onOk);
                    cancelPromptBtn.removeEventListener('click', onCancel);
                };

                okPromptBtn.addEventListener('click', onOk);
                cancelPromptBtn.addEventListener('click', onCancel);
            });
        }

        /**
         * Simple toast/alert function.
         * Replaced `alert()` with the custom modal for better UI.
         * @param {string} msg The message to display.
         */
        function toast(msg) {
            showMessageModal('Notice', msg);
        }

        /**
         * Helper for API calls with error handling.
         * @param {string} url The API endpoint URL.
         * @param {Object} options The fetch options.
         * @returns {Promise<Response>} The response object.
         */
        async function fetchAPI(url, options = {}) {
            try {
                const response = await fetch(`${API_BASE}${url}`, {
                    credentials: 'include',
                    ...options
                });
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ message: 'Unknown error' }));
                    throw new Error(`API Error: ${response.status} - ${errorData.message || response.statusText}`);
                }
                return response;
            } catch (error) {
                console.error(`Fetch API Error for ${url}:`, error);
                showMessageModal('Network Error', `Could not connect to the server or fetch data. Please check your network connection.`);
                throw error;
            }
        }

        /**
         * Counts words in a given text.
         * @param {string} text The text to count.
         * @returns {number} The word count.
         */
        function getWordCount(text) {
            return text.trim().split(/\s+/).filter(word => word.length > 0).length;
        }

        /**
         * Renders a list of items to a container element.
         * @param {HTMLElement} container The DOM element to render into.
         * @param {Array} items The data array.
         * @param {Function} renderItem A function that returns HTML for each item.
         * @param {string} emptyMessage The message to show if the list is empty.
         */
        function renderList(container, items, renderItem, emptyMessage) {
            container.innerHTML = ''; // Clear previous content
            if (items.length === 0) {
                container.innerHTML = `<p class="text-center italic text-gray-500 py-4">${emptyMessage}</p>`;
                return;
            }
            items.forEach(item => {
                container.innerHTML += renderItem(item);
            });
        }

        /**
         * Renders students list.
         */
        function renderStudents() {
            renderList(studentsListEl, students, (s) => `
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center py-4">
                    <span class="flex-1 text-gray-800 text-base font-medium mb-2 sm:mb-0">${sanitizeInput(s.firstname)} ${sanitizeInput(s.lastname)} (Grade ${sanitizeInput(s.grade)})</span>
                    <button onclick="toast('Open assign for ${sanitizeInput(s.email)}')" class="px-3 py-1 bg-blue-500 text-white rounded-md text-sm font-semibold shadow-sm hover:bg-blue-600 transition-colors">Assign</button>
                </div>
            `, 'No students found in your class.');

            // Populate student select for assignments
            studentSelectEl.innerHTML = students.map(s => `<option value="${sanitizeInput(s.email)}">${sanitizeInput(s.firstname)} ${sanitizeInput(s.lastname)} (${sanitizeInput(s.email)})</option>`).join('');
        }

        /**
         * Renders overdue tasks list.
         */
        function renderOverdueTasks() {
            renderList(overdueTasksListEl, overdueTasks, (o) => `
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center py-4">
                    <span class="flex-1 text-gray-800 text-base font-medium mb-2 sm:mb-0">
                        <span class="font-bold">${sanitizeInput(o.student_email)}</span>: "${sanitizeInput(o.title)}" was due ${new Date(o.due_datetime).toLocaleString()}
                    </span>
                    <button onclick="sendMessage('${sanitizeInput(o.student_email)}')" class="px-3 py-1 bg-orange-500 text-white rounded-md text-sm font-semibold shadow-sm hover:bg-orange-600 transition-colors">Remind</button>
                </div>
            `, 'No overdue tasks!');
        }

        /**
         * Renders assigned tasks list.
         */
        function renderAssignedTasks() {
            renderList(assignedTasksListEl, assignedTasks, (t) => `
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center py-4">
                    <span class="flex-1 text-gray-800 text-base font-medium mb-2 sm:mb-0">
                        <span class="font-bold">${sanitizeInput(t.student_email)}</span>: ${sanitizeInput(t.title)} (${sanitizeInput(t.subject)}) due ${new Date(t.due_datetime).toLocaleString()}
                    </span>
                    <div class="flex gap-2 mt-2 sm:mt-0">
                        ${t.attachment ? `<a href="${API_BASE}/uploads/${t.attachment}" target="_blank" class="px-3 py-1 bg-gray-500 text-white rounded-md text-sm font-semibold shadow-sm hover:bg-gray-600 transition-colors">üìé</a>` : ''}
                        <button onclick="sendMessage('${sanitizeInput(t.student_email)}')" class="px-3 py-1 bg-blue-500 text-white rounded-md text-sm font-semibold shadow-sm hover:bg-blue-600 transition-colors">Message</button>
                    </div>
                </div>
            `, 'No tasks assigned yet.');
        }

        /**
         * Renders feedback list.
         */
        function renderFeedback() {
            renderList(feedbackListEl, feedbackList, (f) => `
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center py-4">
                    <span class="flex-1 text-gray-800 text-base font-medium mb-2 sm:mb-0">
                        <span class="font-bold">${sanitizeInput(f.student_email)}</span>: ${sanitizeInput(f.message.slice(0, 100))}${f.message.length > 100 ? '...' : ''}
                    </span>
                    <div class="flex gap-2 mt-2 sm:mt-0">
                        ${f.file_name ? `<a href="${API_BASE}/uploads/${f.file_name}" target="_blank" class="px-3 py-1 bg-gray-500 text-white rounded-md text-sm font-semibold shadow-sm hover:bg-gray-600 transition-colors">üìé</a>` : ''}
                        <button onclick="sendMessage('${sanitizeInput(f.student_email)}')" class="px-3 py-1 bg-blue-500 text-white rounded-md text-sm font-semibold shadow-sm hover:bg-blue-600 transition-colors">Reply</button>
                    </div>
                </div>
            `, 'No student feedback received.');
        }

        /**
         * Sends a message to a student.
         * @param {string} email The student's email.
         */
        async function sendMessage(email) {
            // Input validation and sanitization
            const text = sanitizeInput(await showPromptModal(`Message to ${email}`, 'Type your message below:'));
            if (text === null) {
                // User cancelled
                return;
            }
            if (!text || text.trim() === '') {
                toast('Message cannot be empty.');
                return;
            }
            try {
                const res = await fetchAPI('/api/teacher/message', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ to: email, text: text }),
                });
                if (res.ok) {
                    toast('Message sent!');
                } else {
                    const errorData = await res.json().catch(() => ({ message: 'Failed to send message.' }));
                    toast(`Failed to send message: ${errorData.message}`);
                }
            } catch (error) {
                console.error('Error sending message:', error);
                toast('Failed to send message due to a network error.');
            }
        }

        /**
         * Saves the academic calendar dates.
         */
        async function saveCalendar() {
            // Basic input validation
            const termStart = termStartEl.value;
            const termEnd = termEndEl.value;
            if (!termStart || !termEnd) {
                calendarMsgEl.textContent = 'Please enter both start and end dates.';
                calendarMsgEl.classList.remove('text-green-500');
                calendarMsgEl.classList.add('text-red-500');
                return;
            }

            // More robust date validation
            const startDate = new Date(termStart);
            const endDate = new Date(termEnd);
            if (startDate > endDate) {
                calendarMsgEl.textContent = 'Start date cannot be after end date.';
                calendarMsgEl.classList.remove('text-green-500');
                calendarMsgEl.classList.add('text-red-500');
                return;
            }

            saveCalendarButtonEl.disabled = true;
            calendarMsgEl.textContent = '';
            
            try {
                const res = await fetchAPI('/api/calendar', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    // Backend is expected to handle sanitization and validation
                    body: JSON.stringify({ start: termStart, end: termEnd }),
                });
                if (res.ok) {
                    calendarMsgEl.textContent = 'Calendar saved successfully! ‚úÖ';
                    calendarMsgEl.classList.remove('text-red-500');
                    calendarMsgEl.classList.add('text-green-500');
                } else {
                    calendarMsgEl.textContent = 'Failed to save calendar. ‚ùå';
                    calendarMsgEl.classList.remove('text-green-500');
                    calendarMsgEl.classList.add('text-red-500');
                }
            } catch (error) {
                console.error('Error saving calendar:', error);
                calendarMsgEl.textContent = 'Failed to save calendar due to a network error. ‚ùå';
                calendarMsgEl.classList.remove('text-green-500');
                calendarMsgEl.classList.add('text-red-500');
            } finally {
                saveCalendarButtonEl.disabled = false;
            }
        }

        /**
         * Sends a new assignment.
         */
        async function sendNewAssignment() {
            const studentEmail = studentSelectEl.value;
            const assignmentText = assignmentTextEl.value;
            const wordCount = getWordCount(assignmentText);

            // Client-side validation
            if (!studentEmail) {
                toast('Please select a student.');
                return;
            }
            if (wordCount < 500 && !selectedAssignmentFile) {
                toast('Assignment must be at least 500 words or include an attachment.');
                return;
            }

            sendAssignmentButtonEl.disabled = true;
            const originalButtonText = sendAssignmentButtonEl.textContent;
            sendAssignmentButtonEl.innerHTML = `<div class="spinner mx-auto"></div>`;

            try {
                const formData = new FormData();
                // Sanitize text input before sending
                formData.append('studentEmail', sanitizeInput(studentEmail));
                formData.append('assignmentText', sanitizeInput(assignmentText));

                if (selectedAssignmentFile) {
                    formData.append('assignmentFile', selectedAssignmentFile, selectedAssignmentFile.name);
                }

                const res = await fetchAPI('/api/teacher/assign', {
                    method: 'POST',
                    body: formData,
                });

                if (res.ok) {
                    toast('Assignment sent successfully!');
                    assignmentTextEl.value = '';
                    selectedAssignmentFile = null;
                    fileNameEl.textContent = 'No file selected.';
                    clearFileButtonEl.classList.add('hidden');
                    updateSendButtonState();
                    // Assumes a function to load assigned tasks exists, but for this file it's a placeholder
                    // loadAssignedTasks(); // Refresh list - uncomment if implemented
                } else {
                    const errorData = await res.json().catch(() => ({ message: 'Failed to send assignment.' }));
                    toast(`Failed to send assignment: ${errorData.message}`);
                }
            } catch (error) {
                console.error('Error sending assignment:', error);
                toast('Failed to send assignment due to a network error.');
            } finally {
                sendAssignmentButtonEl.disabled = false;
                sendAssignmentButtonEl.innerHTML = originalButtonText;
            }
        }

        /**
         * Handles logout functionality.
         * Replaced `window.confirm` with the custom modal for a better experience.
         */
        async function logout() {
            const confirmed = await new Promise((resolve) => {
                showPromptModal('Logout Confirmation', 'Are you sure you want to log out?');
                document.getElementById('okPromptBtn').onclick = () => { resolve(true); promptModal.style.display = 'none'; };
                document.getElementById('cancelPromptBtn').onclick = () => { resolve(false); promptModal.style.display = 'none'; };
            });

            if (confirmed) {
                try {
                    await fetchAPI('/api/logout', { method: 'POST' });
                    window.location.href = '/login.html'; // Assuming a login page
                } catch (error) {
                    console.error('Logout failed:', error);
                    toast('Failed to log out. Please try again.');
                }
            }
        }

        /**
         * Updates the state of the send button based on input.
         */
        function updateSendButtonState() {
            const wordCount = getWordCount(assignmentTextEl.value);
            const isSendable = (wordCount >= 500) || (selectedAssignmentFile !== null);
            sendAssignmentButtonEl.disabled = !isSendable;
            wordCountTextEl.textContent = `Word count: ${wordCount}`;
        }
        
        /**
         * Toggles the visibility of the profile dropdown menu.
         */
        function toggleDropdown() {
            isDropdownVisible = !isDropdownVisible;
            if (isDropdownVisible) {
                profileDropdownMenu.classList.remove('hidden');
                setTimeout(() => {
                    profileDropdownMenu.classList.add('visible');
                    profileDropdownMenu.classList.remove('opacity-0');
                }, 10); // Small delay to allow CSS transition
            } else {
                profileDropdownMenu.classList.remove('visible');
                profileDropdownMenu.classList.add('opacity-0');
                // Wait for transition to finish before hiding
                setTimeout(() => {
                    profileDropdownMenu.classList.add('hidden');
                }, 200);
            }
        }

        /**
         * Initializes all event listeners.
         */
        function setupEventListeners() {
            assignmentTextEl.addEventListener('input', updateSendButtonState);
            assignmentFileEl.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    selectedAssignmentFile = file;
                    fileNameEl.textContent = `‚úÖ ${file.name}`;
                    clearFileButtonEl.classList.remove('hidden');
                } else {
                    selectedAssignmentFile = null;
                    fileNameEl.textContent = 'No file selected.';
                    clearFileButtonEl.classList.add('hidden');
                }
                updateSendButtonState();
            });
            clearFileButtonEl.addEventListener('click', () => {
                assignmentFileEl.value = '';
                selectedAssignmentFile = null;
                fileNameEl.textContent = 'No file selected.';
                clearFileButtonEl.classList.add('hidden');
                updateSendButtonState();
            });
            sendAssignmentButtonEl.addEventListener('click', sendNewAssignment);
            saveCalendarButtonEl.addEventListener('click', saveCalendar);
            
            // Event listeners for the new profile dropdown
            profileMenuButton.addEventListener('click', (event) => {
                event.stopPropagation(); // Prevents the document click from closing it immediately
                toggleDropdown();
            });
            document.addEventListener('click', (event) => {
                const isClickInside = profileDropdownMenu.contains(event.target) || profileMenuButton.contains(event.target);
                if (isDropdownVisible && !isClickInside) {
                    toggleDropdown();
                }
            });
            
            logoutButtonEl.addEventListener('click', logout);
        }

        /**
         * Initial data fetching and rendering.
         */
        async function init() {
            try {
                // Check session and occupation
                const sessionRes = await fetchAPI('/api/session');
                const sessionData = await sessionRes.json();
                
                if (!sessionData.loggedIn || sessionData.user.occupation !== 'teacher') {
                    showMessageModal('Authentication Required', 'Please log in as a teacher to access this page.');
                    setTimeout(() => window.location.href = '/login.html', 3000);
                    return;
                }
                
                // Fetch all data concurrently
                const [studentsRes, assignedTasksRes, overdueTasksRes, feedbackRes] = await Promise.all([
                    fetchAPI('/api/teacher/students/class'),
                    fetchAPI('/api/teacher/assigned'),
                    fetchAPI('/api/teacher/overdue'),
                    fetchAPI('/api/teacher/feedback'),
                ]);

                students = await studentsRes.json();
                assignedTasks = await assignedTasksRes.json();
                overdueTasks = await overdueTasksRes.json();
                feedbackList = await feedbackRes.json();

                // Render all sections
                renderStudents();
                renderAssignedTasks();
                renderOverdueTasks();
                renderFeedback();
                updateSendButtonState();

                // Polling for new feedback every 30 seconds
                setInterval(async () => {
                    const res = await fetchAPI('/api/teacher/feedback');
                    feedbackList = await res.json();
                    renderFeedback();
                }, 30000);

            } catch (error) {
                console.error('Initialization failed:', error);
            } finally {
                loadingOverlay.style.display = 'none';
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            setupEventListeners();
            init();
        });

        // Expose functions to the global scope for event handlers in HTML
        window.closeMessageModal = closeMessageModal;
        window.sendMessage = sendMessage;
    </script>
</body>
</html>


