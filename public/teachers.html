<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Teacher Dashboard – SmartStudentAct</title>
  <link rel="stylesheet" href="teachers.css">
  <style>
    /* (Your existing styles unchanged) */
  </style>
</head>
<body>
<header class="teacher-header">
  <h1>📚 Teacher Dashboard</h1>
  <button id="logoutBtn" class="logout-btn">🚪 Logout</button>
</header>

<main>
  <section>
    <h2>🎓 Students in Your Class</h2>
    <ul id="classStudentList"></ul>
  </section>

  <section>
    <h2>📌 Overdue Tasks</h2>
    <ul id="overdueTaskList"><li>Loading…</li></ul>
  </section>

  <section>
    <h2>📝 Assigned Tasks</h2>
    <ul id="assignedTaskList"></ul>
  </section>

  <section>
    <h2>💬 Student Feedback</h2>
    <ul id="feedbackList"></ul>
  </section>

  <section>
    <h2>📅 Academic Calendar</h2>
    <form id="calendarForm">
      <label>Start of Term <input type="date" id="termStart" required></label>
      <label>End of Term <input type="date" id="termEnd" required></label>
      <button type="submit">Save Calendar</button>
    </form>
    <p id="calendarMsg"></p>
  </section>
</main>

<div id="assignModal" class="modal hidden">
  <!-- (same assign task modal with file upload) -->
</div>

<footer style="text-align:center;margin:2rem 0">
  &copy; <span id="year"></span> SmartStudent
</footer>

<script>

const API_BASE = location.hostname === 'localhost'
  ? 'http://localhost:3000'
  : 'https://smartstudent-backend.onrender.com';

const $ = id => document.getElementById(id);
const toast = (msg,type='ok') => {
  const t = document.createElement('div');
  t.className = 'toast';
  t.style.background = type==='err'?'#f44336':'#4caf50';
  t.textContent = msg;
  document.body.appendChild(t);
  setTimeout(()=>t.remove(),4000);
};
const api = (url,opts={}) => fetch(`${API_BASE}${url}`,{credentials:'include',...opts});

// Session & Form setup
(async()=>{
  $('year').textContent = new Date().getFullYear();
  const sess = await api('/api/session').then(r=>r.json());
  if(!sess.loggedIn || sess.user.occupation!=='teacher'){
    location.href='login.html'; return;
  }
  loadStudents();
  loadAssignedTasks();
  loadOverdueTasks();
  loadFeedback();
  startFeedbackPolling();
})();

$('logoutBtn').onclick = async ()=>{
  await api('/api/logout',{method:'POST'});
  location.href='login.html';
};

async function loadStudents(){
  const studs = await api('/api/teacher/students/class').then(r=>r.json());
  const ul = $('classStudentList'); ul.innerHTML = '';
  studs.forEach(s=>{
    const li = document.createElement('li');
    li.innerHTML = `<strong>${s.firstname} ${s.lastname}</strong> (Grade ${s.grade})
      <button onclick="openAssign('${s.email}','${s.firstname} ${s.lastname}')">Assign</button>`;
    ul.appendChild(li);
  });
}

async function loadAssignedTasks(){
  const tasks = await api('/api/teacher/assigned').then(r=>r.json());
  const ul = $('assignedTaskList'); ul.innerHTML = '';
  tasks.forEach(t => {
    const due = new Date(t.due_datetime).toLocaleString();
    const attach = t.attachment
      ? ` <a href="${API_BASE}/uploads/${t.attachment}" target="_blank">📎</a>`
      : '';
    const msgBtn = `<button onclick="openMessage('${t.student_email}')">✉️ Message</button>`;
    const li = document.createElement('li');
    li.innerHTML = `${t.student_email}: <strong>${t.title}</strong> (${t.subject}) due ${due}${attach} ${msgBtn}`;
    ul.appendChild(li);
  });
}

async function loadOverdueTasks(){
  const nowISO = new Date().toISOString();
  const overdue = await api(`/api/teacher/overdue?now=${encodeURIComponent(nowISO)}`).then(r=>r.json());
  const ul = $('overdueTaskList'); ul.innerHTML = '';
  if(overdue.length === 0){
    ul.innerHTML = '<li>No overdue tasks!</li>';
  } else {
    overdue.forEach(o=>{
      const due = new Date(o.due_datetime).toLocaleString();
      const li = document.createElement('li');
      li.innerHTML = `<strong>${o.student_email}</strong>: "${o.title}" was due ${due}
        <button onclick="openMessage('${o.student_email}')">✉️ Remind</button>`;
      ul.appendChild(li);
    });
  }
}

async function loadFeedback(){
  const fb = await api('/api/teacher/feedback').then(r=>r.json());
  const ul = $('feedbackList'); ul.innerHTML = '';
  fb.forEach(f => {
    const attach = f.file_name
      ? ` <a href="${API_BASE}/uploads/${f.file_name}" target="_blank">📎</a>`
      : '';
    const li = document.createElement('li');
    li.innerHTML = `<strong>${f.student_email}</strong>: ${f.message.slice(0,120)}…${attach}
      <button onclick="openMessage('${f.student_email}')">✉️ Reply</button>`;
    ul.appendChild(li);
  });
}

function startFeedbackPolling(){
  setInterval(async ()=>{
    const newFb = await api('/api/teacher/feedback/new').then(r=>r.json());
    if(newFb.count > 0){
      toast(`📬 You have ${newFb.count} new feedback message(s)`);
      loadFeedback();
    }
  }, 30000); // every 30 seconds
}

function openMessage(email){
  const msg = prompt(`Write a message to ${email}:`);
  if(!msg) return;
  api('/api/teacher/message', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({to: email, text: msg})
  }).then(r=>{
    if(r.ok) toast('Message sent!'); else toast('Send failed','err');
  });
}

/* (Keep the assignModal / submitAssign logic unchanged from before) */

$('calendarForm').onsubmit = async e => {
  e.preventDefault();
  const obj = { start: $('termStart').value, end: $('termEnd').value };
  const ok = (await api('/api/calendar',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(obj)})).ok;
  $('calendarMsg').textContent = ok ? 'Saved ✅' : 'Save failed ❌';
};
</script>
</body>
</html>

