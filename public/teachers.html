<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Teacher Dashboard - SmartStudent</title>
  <link rel="stylesheet" href="teachers.css">
  <style>
    .modal { position: fixed; top:0; left:0; width:100%; height:100%;
      background: rgba(0,0,0,0.5); display:flex; align-items:center; justify-content:center; z-index:50; }
    .modal.hidden { display:none; }
    .modal-content { background:#fff; padding:2rem; border-radius:8px; width:90%; max-width:400px; position:relative; }
    .modal .close { position:absolute; top:10px; right:15px; font-size:1.5rem; cursor:pointer; }
    footer { text-align:center; margin:2rem 0; padding:1rem; background:#f8f8f8; border-top:1px solid #ccc; }
  </style>
</head>
<body>
  <!-- Top Nav -->
  <!-- ✅ Fixed Top Header -->
<header class="teacher-header">
  <h1>📚 Teacher Dashboard</h1>
  <button id="logoutBtn" class="logout-btn">🚪 Logout</button>
</header>

  <!-- Main Content -->
  <main class="teacher-container">

    <!-- Quick Assign Modal -->
    <div id="quickAssignModal" class="modal hidden">
      <div class="modal-content">
        <span class="close" onclick="closeAssignModal()">&times;</span>
        <h3>📌 Assign Task</h3>
        <label>To: <b><span id="modalStudentName"></span></b></label>
        <form id="quickAssignForm">
          <select id="existingTasks">
            <option value="">-- Or pick existing task --</option>
          </select>
          <input type="text" id="modalTaskTitle" placeholder="Title" required />
          <input type="text" id="modalTaskSubject" placeholder="Subject" required />
          <input type="date" id="modalTaskDueDate" required />
          <textarea id="modalTaskBrief" maxlength="100" placeholder="Brief note"></textarea>
          <button type="submit">Assign Task</button>
        </form>
      </div>
    </div>

    <!-- Students List -->
    <section class="student-class-list">
      <h2>🎓 Students in Your Class</h2>
      <ul id="classStudentList"></ul>
    </section>

    <!-- Assigned Tasks -->
    <section class="assigned-tasks">
      <h2>📝 Assigned Tasks Overview</h2>
      <ul id="assignedTaskList"></ul>
    </section>

    <!-- Student Progress -->
    <section class="student-progress">
      <h2>📈 Student Progress</h2>
      <label for="toggleClass">View by Class</label>
      <select id="toggleClass"></select>
      <ul id="progressList"></ul>
    </section>

    <!-- Academic Calendar -->
    <section class="calendar-setup">
      <h2>📅 Academic Calendar</h2>
      <form id="calendarForm">
        <label for="termStart">Start of Term</label>
        <input type="date" id="termStart" required />
        <label for="termEnd">End of Term</label>
        <input type="date" id="termEnd" required />
        <button type="submit">Save Calendar</button>
      </form>
    </section>

    <!-- Feedback Area -->
    <section class="feedback-area">
      <h2>💬 Student Feedback</h2>
      <ul id="feedbackList"></ul>
    </section>

    <!-- Reminders -->
    <section class="reminder-area">
      <h2>🔔 Reminders</h2>
      <button onclick="sendReminders()">Send Reminder to Pending Students</button>
      <p id="reminderStatus"></p>
    </section>

  </main>

  <!-- Footer -->
  <footer>
    <p>&copy; <span id="year"></span> SmartStudent. Empowering teachers. Inspiring students.</p>
  </footer>

<script>
  document.getElementById('year').textContent = new Date().getFullYear();

  // Session & Load
  window.onload = async () => {
    const r = await fetch('/api/session', { credentials:'include' });
    const { loggedIn, user } = await r.json();
    if (!loggedIn || user.occupation !== 'teacher') return window.location.href='login.html';
    loadClassStudents();
    loadAssignedTasks();
    loadProgress();
    loadFeedback();
  };

  document.getElementById('logoutBtn').onclick = async () => {
    await fetch('/api/logout',{ method:'POST', credentials:'include' });
    window.location.href = 'login.html';
  };

  // Load class students
  async function loadClassStudents() {
    const res = await fetch('/api/teacher/students/class', { credentials:'include' });
    const students = await res.json();
    students.sort((a,b)=>`${a.firstname} ${a.lastname}`.localeCompare(`${b.firstname} ${b.lastname}`));
    const ul = document.getElementById('classStudentList');
    ul.innerHTML = '';
    students.forEach(st => {
      const li = document.createElement('li');
      li.innerHTML = `<strong>${st.firstname} ${st.lastname}</strong> – Grade ${st.grade}
      <button onclick="initQuickAssign('${st.email}','${st.firstname} ${st.lastname}')">Assign</button>`;
      ul.appendChild(li);
    });
  }

  // Modal and assign logic
  async function initQuickAssign(email, name) {
    document.getElementById('modalStudentName').textContent = name;
    document.getElementById('quickAssignModal').classList.remove('hidden');
    const tasks = await (await fetch('/api/teacher/tasks/existing', { credentials:'include' })).json();
    const sel = document.getElementById('existingTasks');
    sel.innerHTML = '<option value="">-- Or pick existing --</option>';
    tasks.forEach(t => sel.innerHTML +=
      `<option value="${t.id}" data-title="${t.title}" data-subject="${t.subject}" data-due="${t.due_date}" data-brief="${t.note}">${t.title}</option>`);
  }

  document.getElementById('existingTasks').onchange = function() {
    const o = this.options[this.selectedIndex];
    if (!o.value) return;
    document.getElementById('modalTaskTitle').value = o.dataset.title;
    document.getElementById('modalTaskSubject').value = o.dataset.subject;
    document.getElementById('modalTaskDueDate').value = o.dataset.due;
    document.getElementById('modalTaskBrief').value = o.dataset.brief;
  };

  document.getElementById('quickAssignForm').onsubmit = async e => {
    e.preventDefault();
    if(!confirm('Confirm assign?')) return;
    const stName = document.getElementById('modalStudentName').textContent;
    const student_email = Array.from(document.querySelectorAll('#classStudentList li'))
      .find(li => li.textContent.includes(stName)).innerHTML.match(/'(.+?)'/)[1];
    const user = (await (await fetch('/api/session', {credentials:'include'})).json()).user;
    const payload = {
      teacher_email: user.email,
      student_email,
      title: document.getElementById('modalTaskTitle').value.trim(),
      subject: document.getElementById('modalTaskSubject').value.trim(),
      due_date: document.getElementById('modalTaskDueDate').value,
      note: document.getElementById('modalTaskBrief').value.trim()
    };
    const res = await fetch('/api/teacher/assign', {
      method:'POST', headers:{'Content-Type':'application/json'}, credentials:'include',
      body:JSON.stringify(payload)
    });
    if(res.ok) {
      alert('✅ Task assigned!');
      closeAssignModal();
      loadAssignedTasks();
    } else alert('❌ Failed');
  };

  function closeAssignModal(){
    document.getElementById('quickAssignModal').classList.add('hidden');
  }

  // Load assigned tasks
  async function loadAssignedTasks(){
    const tasks = await (await fetch('/api/teacher/assigned',{credentials:'include'})).json();
    const ul = document.getElementById('assignedTaskList'); ul.innerHTML = '';
    tasks.forEach(t => {
      const li=document.createElement('li');
      li.textContent = `${t.student_email}: ${t.title} (${t.subject}) due ${t.due_date}`;
      ul.appendChild(li);
    });
  }

  // Load student progress
  async function loadProgress(){
    const ds = await (await fetch('/api/teacher/students/:progress',{credentials:'include'})).json();
    const ul = document.getElementById('progressList'); ul.innerHTML = '';
    ds.forEach(s=>{
      const li = document.createElement('li');
      li.textContent = `${s.firstname} ${s.lastname}: ${s.progress}% complete`;
      ul.appendChild(li);
    });
  }

  // Load feedback
  async function loadFeedback(){
    const fb = await (await fetch('/api/teacher/feedback',{credentials:'include'})).json();
    const ul = document.getElementById('feedbackList'); ul.innerHTML = '';
    fb.forEach(m=>{
      const li = document.createElement('li');
      li.textContent = `${m.student_email}: ${m.message}`;
      ul.appendChild(li);
    });
  }

  // Academic calendar
  document.getElementById('calendarForm').onsubmit = async e => {
    e.preventDefault();
    const payload = { start: document.getElementById('termStart').value, end: document.getElementById('termEnd').value };
    const res = await fetch('/api/calendar',{method:'POST',credentials:'include',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
    alert(res.ok ? '📅 Calendar saved!' : '❌ Calendar save failed');
  };

  // Reminders
  async function sendReminders(){
    const res = await fetch('/api/teacher/remind',{method:'POST',credentials:'include'});
    document.getElementById('reminderStatus').textContent = res.ok ? '✅ Reminders sent!' : '❌ Failed to send.';
  }
</script>

</body>
</html>
